<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Task Platform with PayPal</title>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- PayPal SDK -->
<script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID&currency=USD"></script>

<style>
body{font-family:Arial,sans-serif;background:#f7f7f7;margin:0;padding:0;}
.container{max-width:800px;margin:20px auto;background:#fff;padding:20px;border-radius:10px;}
button{padding:10px 20px;margin:5px;border:none;border-radius:8px;cursor:pointer;}
</style>
</head>
<body>

<div class="container" id="auth-box">
  <h2>Login / Signup</h2>
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Password"><br>
  <select id="role"><option value="worker">Worker</option><option value="admin">Admin</option></select><br>
  <button onclick="signup()">Sign Up</button>
  <button onclick="login()">Login</button>
</div>

<div class="container" id="worker-box" style="display:none;">
  <h2>Worker Task Page</h2>
  <p id="task-text"></p>
  <button onclick="selectChoice('Valid')">Valid</button>
  <button onclick="selectChoice('Invalid')">Invalid</button>
  <button onclick="selectChoice('Suspicious')">Suspicious</button><br>
  <button onclick="submitChoice()">Submit</button>
  <div id="paypal-button-container"></div>
</div>

<div class="container" id="admin-box" style="display:none;">
  <h2>Admin Panel</h2>
  <input type="text" id="new-task" placeholder="New Task"><button onclick="addTask()">Add Task</button>
  <div id="results"></div>
</div>

<script>
// -------- Firebase Config --------
const firebaseConfig = {
  apiKey: "AIzaSyXXXXXXX",
  authDomain: "your-app.firebaseapp.com",
  projectId: "your-app",
  storageBucket: "your-app.appspot.com",
  messagingSenderId: "123456",
  appId: "1:123456:web:abcd"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// -------- Auth --------
function signup(){
  const email = emailEl.value;
  const pass  = passwordEl.value;
  const role  = roleEl.value;
  auth.createUserWithEmailAndPassword(email,pass)
    .then(u=>db.collection("users").doc(u.user.uid).set({email,role,balance:0}));
}
function login(){
  auth.signInWithEmailAndPassword(emailEl.value,passwordEl.value)
    .then(u=>{
      db.collection("users").doc(u.user.uid).get().then(doc=>{
        if(doc.data().role=="admin") showAdmin(); else showWorker();
      });
    });
}

// -------- Worker --------
let chosen = "";
function selectChoice(c){chosen=c;}
function loadTask(){
  db.collection("tasks").limit(1).get().then(s=>{
    if(s.empty){taskEl.innerText="No tasks!";return;}
    const t = s.docs[0].data();
    taskEl.innerText = t.text;
  });
}
function submitChoice(){
  if(!chosen) return alert("Select!");
  db.collection("results").add({text:taskEl.innerText,choice:chosen,userShare:60,ownerShare:40,paid:false});
  loadTask();
}
function showWorker(){
  authBox.style.display="none";
  workerBox.style.display="block";
  loadTask();
  renderPayPal();
}
function renderPayPal(){
  db.collection("results").where("paid","==",false).get().then(snap=>{
    let total=0;
    snap.forEach(doc=> total += doc.data().userShare);
    if(total>0){
      paypal.Buttons({
        createOrder:(data,actions)=> actions.order.create({purchase_units:[{amount:{value:total}}]}),
        onApprove:(data,actions)=>actions.order.capture().then(details=>{
          alert("Paid "+details.purchase_units[0].amount.value);
          snap.forEach(doci=>doci.ref.update({paid:true}));
        })
      }).render("#paypal-button-container");
    }
  });
}

// -------- Admin --------
function showAdmin(){
  authBox.style.display="none";
  adminBox.style.display="block";
  db.collection("results").onSnapshot(s=>{
    let html="";
    s.forEach(doc=>html += `<p>${doc.data().text} -> ${doc.data().choice}</p>`);
    resultsEl.innerHTML = html;
  });
}
function addTask(){
  db.collection("tasks").add({text:newTaskEl.value});
}

</script>

</body>
</html>

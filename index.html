<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Task Platform - Live</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<!-- PayPal SDK -->
<script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID&currency=USD"></script>

<style>
body { font-family: Arial, sans-serif; background:#f0f0f0; margin:0; padding:0; }
.container { max-width:900px; margin:20px auto; background:#fff; padding:20px; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.2); }
h2,h3 { color:#333; text-align:center; }
input, select { padding:10px; margin:5px 0; width:100%; border-radius:8px; border:1px solid #ccc; }
button { padding:10px 20px; margin:5px 0; border:none; border-radius:10px; cursor:pointer; font-weight:bold; }
button#submit-btn{background:#007bff;color:#fff;width:100%;}
.progress{height:20px;background:#ddd;border-radius:10px;overflow:hidden;margin-top:15px;}
.progress-bar{height:100%;width:0%;background:#007bff;text-align:center;color:#fff;line-height:20px;}
.admin-panel{margin-top:30px;}
.admin-panel table{width:100%;border-collapse:collapse;}
.admin-panel th, .admin-panel td{border:1px solid #ccc;padding:8px;text-align:center;}
.admin-panel th{background:#007bff;color:#fff;}
#paypal-button-container{margin-top:15px;}
</style>
</head>
<body>

<!-- AUTH -->
<div class="container auth-container">
  <h2>Login / Signup</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <select id="role">
    <option value="worker">Worker</option>
    <option value="admin">Admin</option>
  </select>
  <button onclick="signup()">Sign Up</button>
  <button onclick="login()">Login</button>
</div>

<!-- WORKER PAGE -->
<div class="container" id="worker-container" style="display:none;">
  <h2>Worker Task Page</h2>
  <p id="survey-text"></p>
  <div class="buttons">
    <button onclick="selectChoice('Valid')">‚úÖ Valid</button>
    <button onclick="selectChoice('Invalid')">‚ùå Invalid</button>
    <button onclick="selectChoice('Suspicious')">‚ö† Suspicious</button>
  </div>
  <button id="submit-btn" onclick="submitTask()">Submit & Next</button>
  <div class="progress">
    <div class="progress-bar" id="progress-bar">0%</div>
  </div>
  <div id="paypal-button-container"></div>
</div>

<!-- ADMIN PAGE -->
<div class="container admin-panel" id="admin-container" style="display:none;">
  <h2>Admin Panel</h2>
  <input type="text" id="new-task" placeholder="New Task Text">
  <button onclick="addTask()">Add Task</button>
  <table id="tasks-table">
    <thead><tr><th>Task</th><th>Delete</th></tr></thead>
    <tbody></tbody>
  </table>
  <h3>Results & Payment</h3>
  <table id="results-table">
    <thead><tr><th>Task</th><th>Worker Choice</th><th>Your 40%</th><th>User 60%</th></tr></thead>
    <tbody></tbody>
  </table>
  <p id="summary"></p>
</div>

<script>
// üîπ Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyXXXXXXX-XXXXXX",
  authDomain: "taskplatform.firebaseapp.com",
  projectId: "taskplatform",
  storageBucket: "taskplatform.appspot.com",
  messagingSenderId: "1234567890",
  appId: "1:1234567890:web:abcdef123456"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// üîπ Global Variables
let currentTask = 0, selectedChoice = "";
let tasks = [], results = [];
let currentUserEmail="";

// üîπ Authentication
function signup(){
  const email=document.getElementById('email').value;
  const password=document.getElementById('password').value;
  const role=document.getElementById('role').value;
  auth.createUserWithEmailAndPassword(email,password)
    .then(cred=>db.collection('users').doc(cred.user.uid).set({email,role}))
    .then(()=>alert("User created successfully!"))
    .catch(err=>alert(err.message));
}

function login(){
  const email=document.getElementById('email').value;
  const password=document.getElementById('password').value;
  auth.signInWithEmailAndPassword(email,password)
    .then(cred=>{
      db.collection('users').doc(cred.user.uid).get().then(doc=>{
        const role=doc.data().role;
        currentUserEmail=email;
        document.querySelector('.auth-container').style.display='none';
        if(role==='admin'){document.getElementById('admin-container').style.display='block'; loadTasks(); loadResults();}
        else{document.getElementById('worker-container').style.display='block'; loadTasksWorker();}
      });
    })
    .catch(err=>alert(err.message));
}

// üîπ Worker Functions
function loadTasksWorker(){
  db.collection('tasks').get().then(snapshot=>{
    tasks = snapshot.docs.map(doc=>({id:doc.id,text:doc.data().text}));
    currentTask=0; loadTask();
  });
}

function loadTask(){
  if(currentTask<tasks.length){
    document.getElementById('survey-text').innerText = tasks[currentTask].text;
    selectedChoice="";
  } else {
    document.getElementById('survey-text').innerText="All tasks completed! üéâ";
    document.querySelector('.buttons').style.display='none';
    document.getElementById('submit-btn').style.display='none';
    renderPayPal();
  }
  updateProgress();
}

function selectChoice(choice){selectedChoice=choice;}

function submitTask(){
  if(selectedChoice===""){alert("Select an option!"); return;}
  const userShare=60, ownerShare=40;
  db.collection('results').add({taskId:tasks[currentTask].id,taskText:tasks[currentTask].text,choice:selectedChoice,userShare,ownerShare,timestamp:new Date(),paid:false})
  .then(()=>{currentTask++; loadTask(); loadResults();});
}

function updateProgress(){
  const percent=Math.round((currentTask/tasks.length)*100);
  const bar=document.getElementById('progress-bar');
  bar.style.width=percent+"%";
  bar.innerText=percent+"%";
}

// üîπ Admin Functions
function addTask(){
  const text=document.getElementById('new-task').value;
  if(text===""){alert("Enter task!"); return;}
  db.collection('tasks').add({text,createdAt:new Date()}).then(()=>{document.getElementById('new-task').value=''; loadTasks();});
}

function loadTasks(){
  db.collection('tasks').get().then(snapshot=>{
    const tbody=document.getElementById('tasks-table').querySelector('tbody');
    tbody.innerHTML="";
    snapshot.forEach(doc=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${doc.data().text}</td><td><button onclick="deleteTask('${doc.id}')">Delete</button></td>`;
      tbody.appendChild(tr);
    });
  });
}

function deleteTask(id){db.collection('tasks').doc(id).delete().then(loadTasks);}

function loadResults(){
  db.collection('results').get().then(snapshot=>{
    results=snapshot.docs.map(doc=>doc.data());
    updateAdmin();
  });
}

function updateAdmin(){
  const tbody=document.getElementById('results-table').querySelector('tbody');
  tbody.innerHTML=""; let totalUser=0,totalOwner=0;
  results.forEach(r=>{
    tbody.innerHTML+=`<tr><td>${r.taskText}</td><td>${r.choice}</td><td>$${r.ownerShare}</td><td>$${r.userShare}</td></tr>`;
    totalUser+=r.userShare; totalOwner+=r.ownerShare;
  });
  document.getElementById('summary').innerText=`Total Payment: You $${totalOwner} | Users $${totalUser}`;
}

// üîπ PayPal Button for Worker Payment
function renderPayPal(){
  const unpaidTasks = results.filter(r=>!r.paid);
  const totalAmount = unpaidTasks.reduce((acc,r)=>acc+r.userShare,0);
  if(totalAmount<=0)return;
  paypal.Buttons({
    createOrder:function(data,actions){return actions.order.create({purchase_units:[{amount:{value:totalAmount}}]});},
    onApprove:function(data,actions){return actions.order.capture().then(details=>{
      alert('Payment Successful!');

      unpaidTasks.forEach(task=>{
        db.collection('results').doc(task.taskId).update({paid:true,paymentDetails:details});
      });
    })
  }).render('#paypal-button-container');
}
</script>
</body>
  </html>
